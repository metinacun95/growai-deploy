databases:
  - name: growai-db
    databaseName: devgrowai
    ipAllowList: []  # public eriÅŸim yok; sadece Render iÃ§inden baÄŸlanÄ±lsÄ±n

services:
  # ðŸ”µ Keycloak (Web Service - Docker)
  - type: web
    name: keycloak
    env: docker
    plan: free
    numInstances: 1
    dockerCommand: >
      start --import-realm
    image:
      url: quay.io/keycloak/keycloak:26.1
    envVars:
      # Admin
      - key: KEYCLOAK_ADMIN
        value: admin
      - key: KEYCLOAK_ADMIN_PASSWORD
        value: admin

      # DB config (Render DB'den otomatik)
      - key: KC_DB
        value: postgres
      - key: KC_DB_URL_HOST
        fromDatabase:
          name: growai-db
          property: host
      - key: KC_DB_URL_PORT
        fromDatabase:
          name: growai-db
          property: port
      - key: KC_DB_URL_DATABASE
        fromDatabase:
          name: growai-db
          property: database
      - key: KC_DB_USERNAME
        fromDatabase:
          name: growai-db
          property: user
      - key: KC_DB_PASSWORD
        fromDatabase:
          name: growai-db
          property: password

      # Health & logs
      - key: KC_HEALTH_ENABLED
        value: "true"
      - key: KC_METRICS_ENABLED
        value: "true"

      # Prod mod (dev yerine)
      # start-dev deÄŸil; render/dockerCommand'da 'start --import-realm' dedik
      # Hostname'i Render dÄ±ÅŸ URL'si Ã¼zerinden otomatik algÄ±lamasÄ±nÄ± istiyoruz
      - key: KC_HOSTNAME_STRICT
        value: "false"
      - key: KC_HOSTNAME_STRICT_HTTPS
        value: "false"

    # realm export'unu repo'ya eklediÄŸini varsayÄ±yorum (aynÄ± klasÃ¶rde)
    # Ã–rn: realm-export.json
    staticPublishPath: ""   # (docker olduÄŸu iÃ§in kullanÄ±lmÄ±yor)
    disk:
      name: kc-import
      mountPath: /opt/keycloak/data/import
      sizeGB: 1
    # Disk boÅŸ geleceÄŸi iÃ§in import dosyasÄ±nÄ± image iÃ§ine deÄŸil repo'ya koyuyoruz.
    # Render Docker servisinde 'files' section yok; bu yÃ¼zden realm dosyasÄ±nÄ± image ile ship etmiyorsan
    # kÃ¼Ã§Ã¼k bir init script ile curl/wget koyabilirsin. KolayÄ±: realm'Ä± Keycloak UI'dan bir kez oluÅŸtur.

    # Health check (opsiyonel)
    healthCheckPath: /

  # ðŸŸ  Backend (Web Service - Docker)
  - type: web
    name: growai-backend
    env: docker
    plan: free
    numInstances: 1
    image:
      url: metinacun95/growai:latest
    envVars:
      # DB
      - key: SPRING_DATASOURCE_URL
        # jdbc:postgresql://host:port/db
        value: jdbc:postgresql://$(PG_HOST):$(PG_PORT)/$(PG_DB)
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: growai-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: growai-db
          property: password
      - key: PG_HOST
        fromDatabase:
          name: growai-db
          property: host
      - key: PG_PORT
        fromDatabase:
          name: growai-db
          property: port
      - key: PG_DB
        fromDatabase:
          name: growai-db
          property: database

      # Keycloak issuer: Keycloak servisinin public URL'si + /realms/growai
      - key: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI
        fromService:
          name: keycloak
          type: web
          property: url
          # backend'de: ${SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI}/realms/growai
      - key: ISSUER_REALM_PATH
        value: /realms/growai
      - key: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI
        # JWK set URI otomatik issuer'dan bulunur; istersen aÃ§Ä±k ver:
        fromService:
          name: keycloak
          type: web
          property: url

      - key: SPRING_PROFILES_ACTIVE
        value: docker
      - key: TZ
        value: Europe/Istanbul

    # Render, 10000 dÄ±ÅŸÄ± portlarÄ± reverse proxy'ler; Docker imajÄ±n 8081 dinliyorsa sorun yok.
    healthCheckPath: /actuator/health
    autoDeploy: true

  # ðŸŸ£ Frontend (Web Service - Docker)
  - type: web
    name: growai-frontend
    env: docker
    plan: free
    numInstances: 1
    image:
      url: metinacun95/growai-fe:latest
    envVars:
      # VITE_API_BASE_URL = backend'in public URL'si
      - key: VITE_API_BASE_URL
        fromService:
          name: growai-backend
          type: web
          property: url
      - key: TZ
        value: Europe/Istanbul
    # Docker imajÄ±n 80'de serve ediyorsa auto ok.
    healthCheckPath: /
    autoDeploy: true
